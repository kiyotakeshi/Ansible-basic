### playbookを使った環境の構築

- playbookの実行

```
$ cat loadbalancer.yaml
---
- hosts: loadbalancer
  become: true
  tasks:
    - name: install nginx

      # presentは初回のインストールで最新のものをインストールするが、アップデートはかけない
      # latestにするとアップグレードを自動で行う
      # absentにすると削除
      apt: name=nginx state=present update_cache=yes

$ ls
ansible.cfg		dev			playbooks
database.yaml		loadbalancer.yaml

$ ansible-playbook loadbalancer.yaml
 [WARNING]: Found both group and host with same name: control


PLAY [loadbalancer] **********************************************************************************

TASK [Gathering Facts] *******************************************************************************
ok: [lb01]

TASK [install nginx] *********************************************************************************
 [WARNING]: Updating cache and auto-installing missing dependency: python-apt

 [WARNING]: Could not find aptitude. Using apt-get instead

changed: [lb01]

PLAY RECAP *******************************************************************************************
lb01                       : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```

- 対象サーバにて確認

```
// インストールされている
$ sudo dpkg -l nginx
Desired=Unknown/Install/Remove/Purge/Hold
| Status=Not/Inst/Conf-files/Unpacked/halF-conf/Half-inst/trig-aWait/Trig-pend
|/ Err?=(none)/Reinst-required (Status,Err: uppercase=bad)
||/ Name                Version        Architecture   Description
+++-===================-==============-==============-============================================
ii  nginx               1.10.3-1+deb9u all            small, powerful, scalable web/proxy server

// 削除
$ sudo apt remove --purge nginx
Reading package lists... Done
Building dependency tree
Reading state information... Done

// 削除できている
kiyotatakeshi@ansible-template-1:~$ sudo dpkg -l nginx
Desired=Unknown/Install/Remove/Purge/Hold
| Status=Not/Inst/Conf-files/Unpacked/halF-conf/Half-inst/trig-aWait/Trig-pend
|/ Err?=(none)/Reinst-required (Status,Err: uppercase=bad)
||/ Name                Version        Architecture   Description
+++-===================-==============-==============-============================================
un  nginx               <none>         <none>         (no description available)

```

- 再度playbookを実行

```
$ ansible-playbook loadbalancer.yaml

PLAY [loadbalancer] **********************************************************************************

TASK [Gathering Facts] *******************************************************************************
ok: [lb01]

TASK [install nginx] *********************************************************************************
 [WARNING]: Could not find aptitude. Using apt-get instead

changed: [lb01]

PLAY RECAP *******************************************************************************************
lb01                       : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

// 接続、IPはダミー
$ ssh 38.213.8.209 -p 1994
Linux ansible-template-1 4.9.0-9-amd64 #1 SMP Debian 4.9.168-1+deb9u8 (2019-08-11) x86_64

// 再度、インストールできている
kiyotatakeshi@ansible-template-1:~$ sudo dpkg -l nginx
Desired=Unknown/Install/Remove/Purge/Hold
| Status=Not/Inst/Conf-files/Unpacked/halF-conf/Half-inst/trig-aWait/Trig-pend
|/ Err?=(none)/Reinst-required (Status,Err: uppercase=bad)
||/ Name                Version        Architecture   Description
+++-===================-==============-==============-============================================
ii  nginx               1.10.3-1+deb9u all            small, powerful, scalable web/proxy server

```